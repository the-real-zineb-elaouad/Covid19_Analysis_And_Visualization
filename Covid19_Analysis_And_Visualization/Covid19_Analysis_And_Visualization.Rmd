---
title: "projet"
output: html_document
date: "2025-04-08"
install.packages("patchwork")
#runtime: shiny
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(plotly)
library(htmlwidgets)
#library(gridExtra)
#library(scales)
#library(shiny)
```

To learn more, see [Interactive Documents](http://rmarkdown.rstudio.com/authoring_shiny.html).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
CovidData <- read.csv("../data/owid-covid-data.csv", sep = ",")
CovidData %>% head(10)
```
# I/ Préparation et nettoyage des données
## 1. Vérification et convertions des types de variables
```{r}
str(CovidData)
```
### Conversion de la date et des variables catégorielles
```{r}
CovidData$date <- as.Date(CovidData$date)
CovidData$continent <- as.factor(CovidData$continent)
CovidData$location <- as.factor(CovidData$location)
CovidData$iso_code <- as.factor(CovidData$iso_code)
str(CovidData)

```
## 2. Suppression des colonnes avec plus de 90 % de valeurs manquantes
toutes les colonnes contenant plus de 90% de valeurs manquantes (NA) ont été retirées. Leurs noms sont conservés dans une variable colonnes_supprimees à des fins de traçabilité.
```{r}
na_ratio <- colMeans(is.na(CovidData))

colonnes_supprimees <- names(na_ratio[na_ratio > 0.9])

CovidData_clean <- CovidData[, !(names(CovidData) %in% colonnes_supprimees)]

colonnes_supprimees
```
## 3. Détection, traitement et suppression des doublons
### - Detectetion
#### Nous avons détecté 7 770 doublons sur la combinaison location + date. Ces doublons n'étaient pas de simples répétitions, mais souvent deux lignes contenant des données partielles. C'EST DES DONNEES FRAGMENTEES

```{r}
doublons <- duplicated(CovidData_clean[, c("date", "location")])
CovidData_clean[doublons, ]
```
```{r}
doublons <- CovidData_clean %>%
  filter(duplicated(select(., location, date)) | duplicated(select(., location, date), fromLast = TRUE))


doublons <- doublons %>% arrange(location, date)
doublons
```
### - Traitement des doublons
#### fusionné chaque groupe de doublons (location, date) en une seule ligne, en conservant Pour chaque colonne, la valeur non manquante (non-NA) si elle existe. Si les deux valeurs sont NA, le NA est conservé
```{r}
fusionnes <- doublons %>%
  group_by(location, date) %>%
  summarise(across(everything(), ~ first(na.omit(.))), .groups = "drop")
fusionnes
```

### - Suppression des doublons après fusion
#### Suppression des anciennes lignes doublées du jeu de données initial + Ajout des lignes fusionnées à leur place
```{r}
CovidData_sans_doublons <- CovidData_clean %>%
  filter(!(paste(location, date) %in% paste(doublons$location, doublons$date)))

CovidData_clean <- bind_rows(CovidData_sans_doublons, fusionnes) %>%
  arrange(location, date)

CovidData_clean
```

## 4. ReVérification des donees et Chargement dans CovidData_Prepared 
```{r}
str(CovidData_clean)
summary(CovidData_clean)
CovidData_Prepared <- CovidData_clean
```

# ++++++++++++++++++++++++++ FIN PREPARATION DES DONNEES +++++++++++++++++++++++++++++++

```{r}
ListeLocation <- CovidData_Prepared %>% select(location) %>% distinct()
ListeLocation
```

```{r}
continents <- c("Africa", "Asia", "Europe", "North America",
    "South America", "Oceania")

continents

```
```{r}
regions_agregats <- c(
    "World", "European Union (27)", 
    "High-income countries", "Low-income countries",
    "Lower-middle-income countries", "Upper-middle-income countries"
  )
regions_agregats
```

```{r}
territory_or_dependency <- c(
      "England", "Scotland", "Wales", "Northern Ireland", "Puerto Rico", 
      "Hong Kong", "Macao", "Greenland", "Guadeloupe", "Martinique", 
      "French Guiana", "French Polynesia", "Reunion", "Mayotte", "New Caledonia", 
      "Aruba", "Curacao", "Bonaire Sint Eustatius and Saba", "Gibraltar", 
      "Guernsey", "Jersey", "Isle of Man", "Faroe Islands", "Falkland Islands", 
      "Saint Martin (French part)", "Sint Maarten (Dutch part)", "Saint Barthelemy", 
      "Saint Pierre and Miquelon", "Cayman Islands", "Bermuda", "British Virgin Islands", 
      "United States Virgin Islands", "Turks and Caicos Islands", "Anguilla", 
      "Montserrat", "Cook Islands", "Tokelau", "Niue", "Pitcairn", "Western Sahara", 
      "Palestine", "Kosovo", "Northern Cyprus", "Taiwan", "Vatican", 
      "Micronesia (country)")

territory_or_dependency
```

```{r}
CovidData_Prepared <- CovidData_Prepared %>%
  mutate(type_location = case_when(
    location %in% continents ~ "continent",
    location %in% regions_agregats ~ "region_or_aggregate",
    location %in% territory_or_dependency ~ "territory_or_dependency",
    .default = "country"
  ))
CovidData_Prepared
```

```{r}
CovidData_Prepared %>% select(location, type_location) %>% distinct()
```


```{r}
CovidData_Prepared %>% filter(location == 'France')
```
# --------------------------------------------------------------------------------
### Nettoyage des colonnes communes inutilisés

```{r}
CovidDataClean <- CovidData %>% select(-iso_code, -new_cases_smoothed,-new_deaths_smoothed, -new_cases_smoothed_per_million, -new_deaths_smoothed_per_million, -new_tests_smoothed, -new_tests_smoothed_per_thousand, -new_vaccinations_smoothed, -new_vaccinations_smoothed_per_million, -new_people_vaccinated_smoothed, -new_people_vaccinated_smoothed_per_hundred)

CovidDataClean
```


### 
```{r}
df_evolution_temporelle <- CovidDataClean %>% select(continent, location, date, total_cases, new_cases, total_deaths, total_cases_per_million, new_cases_per_million, total_deaths_per_million, new_deaths_per_million, reproduction_rate, stringency_index, type_location)

df_evolution_temporelle
```

# --------------------------------------------------------------------------------


















## -----------------------------------------------------------------  SALAH -------------------------------------------------------------






-------------------------------------------------------------


## -----------------------------------------------------------------  ZINEB -------------------------------------------------------------


## -----------------------------------------------------------------  SADOU

# récupérerer les 5 pays d'europe les plus touchées par le covid-19 en se basant sur le nombre total de cas enregister pour chaque pays

```{r fig.width=12, fig.height=8}

# la liste des 5 pays les plus touchés et leurs totals de cas  

top5EuropeanContaminedCountries <-CovidData_Prepared %>%
  filter(type_location %in% c("country","territory_or_dependency"), continent =="Europe") %>%
  group_by(location) %>%
  summarize(max_cases = max(total_cases, na.rm = TRUE)) %>% arrange((desc(max_cases)))%>% slice(1:5)
top5EuropeanContaminedCountries

# filtre de la dataset sur ces 5 pays

top_5_countriesName<-top5EuropeanContaminedCountries$location

data_top5_contamined_countries <-CovidData_Prepared %>%
  filter(location %in% top_5_countriesName)
#data_top5_contamined_countries
```



# Le graphe représentant nombre moyen par jour de nouveaux cas enregisté pour les 5 pays les plus touchés d'Europe

```{r fig.width=12, fig.height=8}

library(ggplot2)
library(dplyr)
library(patchwork) 

# Graphique pour les 5 Europe les plus touchés plus touchées d'europe

p1 <- ggplot(data_top5_contamined_countries, aes(x = date, y = new_cases_smoothed, color = location)) +
  geom_line(size = 0.6) +
  
  # AXES
  scale_x_date(
    date_breaks = "3 months",
    date_labels = "%d %b %Y",
    date_minor_breaks = "1 month"
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  
  # TITRES ET LIBELLÉS
  labs(
    title = "Nombre moyens par jour de nouveaux cas enregisté pour les 5  pays les plus touchés d'Europe sur toute la période",
    x = "Date",
    y = "Nombre moyen par jour de nouveaux cas"
  ) +
  
  # THÈME GÉNÉRAL
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    
    # GRILLE
    panel.grid.major = element_line(color = "gray80", size = 0.3),
    panel.grid.minor = element_line(color = "gray90", size = 0.2, linetype = "dotted"),
    
    # LÉGENDE
    legend.position = "bottom"
  )




# Crée le graphique interactif
interactive_plot <- ggplotly(p1)

# Sauvegarde dans un fichier temporaire
temp_file <- tempfile(fileext = ".html")
saveWidget(interactive_plot, temp_file)

# Ouvre dans le navigateur
browseURL(temp_file)



```


# Le graphe représentant nombre moyen par jour de nouveaux décés enregisté pour les 5 pays les plus touchés d'Europe

```{r fig.width=12, fig.height=8}

library(ggplot2)
library(dplyr)
library(patchwork) 

# Graphique de l'évolutions moyen par jour des nouveaux décés confirmés pour les 5 pays Europe les plus touchés

p1 <- ggplot(data_top5_contamined_countries, aes(x = date, y = new_deaths_smoothed, color = location)) +
  geom_line(size = 0.6) +
  
  # AXES
  scale_x_date(
    date_breaks = "3 months",
    date_labels = "%d %b %Y",
    date_minor_breaks = "1 month"
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  
  # TITRES ET LIBELLÉS
  labs(
    title = "Nombre moyens par jour de nouveaux décés enregisté pour les 5  pays les plus touchés d'Europe sur toute la période",
    x = "Date",
    y = "Nombre moyen par jour de nouveaux de décés"
  ) +
  
  # THÈME GÉNÉRAL
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    
    # GRILLE
    panel.grid.major = element_line(color = "gray80", size = 0.3),
    panel.grid.minor = element_line(color = "gray90", size = 0.2, linetype = "dotted"),
    
    # LÉGENDE
    legend.position = "bottom"
  )




# Crée le graphique interactif
interactive_plot <- ggplotly(p1)

# Sauvegarde dans un fichier temporaire
temp_file <- tempfile(fileext = ".html")
saveWidget(interactive_plot, temp_file)

# Ouvre dans le navigateur
browseURL(temp_file)



```

# L'évolution du nombre moyen par jour de nouveau cas et de nouveau décés pour chacun des 5 pays les plus touchés de l'Europe sur toute la période 


```{r fig.width=12, fig.height=8}
library(ggplot2)
library(dplyr)


data_dual <- data_top5_contamined_countries %>%
  select(date, location, new_cases_smoothed, new_deaths_smoothed)

compare <- ggplot(data_dual, aes(x = date)) +
  geom_line(aes(y = new_cases_smoothed, color = "Nombre moyen nouveau cas par jour"), size = 1) +
  geom_line(aes(y = new_deaths_smoothed * 20, color = "Nombre moyen de nouveau décés par jour * 20"), size = 1) +  # Multiplié pour rendre visible

  facet_wrap(~location, scales = "free_y", ncol = 2) +
  
  scale_x_date(
    date_breaks = "3 months",
    date_labels = "%d %b %Y"
  ) +
  
  scale_y_continuous(
    name = "Nouveaux cas (moyenne 7j)",
    labels = scales::comma,
    sec.axis = sec_axis(~ . / 20, name = "Décès (moyenne 7j)")  # Transformation inverse
  ) +
  
  scale_color_manual(
    values = c("Nombre moyen nouveau cas par jour" = "steelblue", "Nombre moyen de nouveau décés par jour * 20" = "firebrick")
  ) +
  
  labs(
    title = "Courbe de nombre moyes de nouveau cas et décés confimées sur toute la période",
    x = "Date",
    color = "Indicateur"
  ) +
  
  theme_minimal(base_size = 12) +
  theme(
    strip.text = element_text(face = "bold", size = 11),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    legend.position = "bottom"
  )

# Crée le graphique interactif
interactive_plot <- ggplotly(compare)

# Sauvegarde dans un fichier temporaire
temp_file <- tempfile(fileext = ".html")
saveWidget(interactive_plot, temp_file)

# Ouvre dans le navigateur
browseURL(temp_file)

```

-------------------------------------------------------------


## -----------------------------------------------------------------  SIAKA

```{r}
# Charger les librairies
library(tidyverse)
library(lubridate)


#chargement de donnees
#covid_data <- read_csv(file="data/owid-covid-data.csv")
#traitement globale par mois

# Sélectionner les 5 pays les plus touchés en Europe (en nombre total de cas)
#pays_cibles <- c("France", "Germany", "Italy", "Russia", "United Kingdom")

# Filtrer les colonnes utiles
donnees_vaccins <- CovidData_Prepared %>%
  filter(location %in% data_top5_contamined_countries) %>%
  select(date, pays = location, personnes_vaccinees = people_vaccinated) %>%
  filter(!is.na(personnes_vaccinees)) %>%
  mutate(date = as.Date(date))

# Tracer le graphique avec ggplot2
ggplot(donnees_vaccins, aes(x = date, y = personnes_vaccinees, color = pays)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Évolution du nombre de personnes vaccinées contre la COVID-19",
    x = "Date",
    y = "Personnes vaccinées (cumul)",
    color = "Pays"
  ) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()

#traitement detailles
donnees_vaccins <- CovidData_Prepared %>%
  filter(location %in% data_top5_contamined_countries) %>%
  select(date, pays = location, personnes_vaccinees = total_vaccinations) %>%
  filter(!is.na(personnes_vaccinees)) %>%
  mutate(date = as.Date(date))

# Tracer le graphique avec ggplot2
ggplot(donnees_vaccins, aes(x = date, y = personnes_vaccinees, color = pays)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Évolution du nombre de personnes vaccinées contre la COVID-19 sur 7 jour ",
    x = "Date",
    y = "Personnes vaccinées (cumul)",
    color = "Pays"
  ) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()

#traitement comparer avec le nombre de cas 

# Préparer les données : cas et vaccination
donnees <- CovidData_Prepared %>%
  filter(location %in% data_top5_contamined_countries) %>%
  select(
    date,
    pays = location,
    new_cases_smoothed,
    taux_vaccination = people_vaccinated
  ) %>%
  filter(!is.na(new_cases_smoothed) & !is.na(taux_vaccination)) %>%
  mutate(date = as.Date(date))

# Créer le graphique combiné
ggplot(donnees, aes(x = date)) +
  # Courbe des nouveaux cas (axe gauche)
  geom_line(aes(y = new_cases_smoothed, color = pays), linewidth = 1) +
  # Courbe du taux de vaccination (axe droit, après transformation)
  geom_line(aes(y = taux_vaccination * 1000, linetype = pays), color = "black", linewidth = 0.8) +
  scale_y_continuous(
    name = "Nouveaux de covid",
    sec.axis = sec_axis(~ . / 1000, name = "Taux de vaccination (% population)")
  ) +
  labs(
    title = "Variation des cas COVID-19 et taux de vaccination",
    x = "Date",
    color = "Pays (cas)",
    linetype = "Pays (vaccination)"
  ) +
  theme_minimal() +
  theme(
    axis.title.y.right = element_text(color = "black"),
    axis.title.y.left = element_text(color = "black")
  )

```

# -------------------------------------------------------------
## -----------------------------------------------------------------  ALIOU -------------------------------------------------------------

```{r}
Africa <- df_evolution_temporelle %>% filter(continent == "Africa")
Africa
```
```{r}
ggplot(Africa, aes(x = date, y = new_cases)) +
  geom_line() +
  labs(title = "Évolution mondiale des cas COVID-19", x = "Date", y = "Cas journaliers lissés")
```


```{r}
ggplot(data = Africa) +  
  aes(x = long, y = lat, group = group) + 
  geom_polygon(fill = "blue", alpha = .4) + 
  theme_classic() +
  coord_map(projection = "mercator") +
  geom_point(data = us_wind %>% filter(ylat < 50 & ylat > 25), 
             mapping = aes(x = xlong, y = ylat, group = NULL), 
             size = .5, col = "orange", alpha = .6) + 
  theme_void() + 
  labs(title = "Wind turbines in the continental US") + 
  labs(caption = "Tidy Tuesday exercise") +
  labs(subtitle = "Data Source: | Visualization: Gina Reynolds")
```

```{r}
CovidDataClean %>% filter(location == "Martinique")
```






## =============================================== FIN ================================================================


## Inputs and Outputs

You can embed Shiny inputs and outputs in your document. Outputs are automatically updated whenever inputs change.  This demonstrates how a standard R plot can be made interactive by wrapping it in the Shiny `renderPlot` function. The `selectInput` and `sliderInput` functions create the input widgets used to drive the plot.

```{r}
# Chargement des données OWID
Covid19 <- read_delim("./owid-covid-data.csv", delim = ",") %>%
  filter(location %in% c("France", "Germany", "Italy")) %>%
  filter(!is.na(total_cases), !is.na(total_deaths)) %>%
  mutate(date = as.Date(date))

 

```
```{r}
# Graphique 1 : Cas cumulés
p1 <- ggplot(Covid19, aes(x = date, y = total_cases, color = location)) +
  geom_line(size = 1) +
  scale_y_log10(labels = comma) +
  labs(title = "Cas cumulés (échelle logarithmique)", x = "Date", y = "Total cas", color = "Pays") +
  theme_minimal(base_size = 14)

# Graphique 2 : Décès cumulés
p2 <- ggplot(Covid19, aes(x = date, y = total_deaths, color = location)) +
  geom_line(size = 1) +
  scale_y_log10(labels = comma) +
  labs(title = "Décès cumulés (échelle logarithmique)", x = "Date", y = "Total décès", color = "Pays") +
  theme_minimal(base_size = 14)

# Afficher les deux côte à côte
grid.arrange(p1, p2, ncol = 2)



```
